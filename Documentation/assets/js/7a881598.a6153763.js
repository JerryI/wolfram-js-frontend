"use strict";(self.webpackChunkwlx_docs=self.webpackChunkwlx_docs||[]).push([[4064],{62956:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>d});var t=a(17624),i=a(4552);const o={draft:!1},r=void 0,s={id:"frontend/Advanced/Dynamics/Advanced animation",title:"Advanced animation",description:"Summary",source:"@site/docs/frontend/Advanced/Dynamics/Advanced animation.md",sourceDirName:"frontend/Advanced/Dynamics",slug:"/frontend/Advanced/Dynamics/Advanced animation",permalink:"/frontend/Advanced/Dynamics/Advanced animation",draft:!1,unlisted:!1,tags:[],version:"current",lastUpdatedAt:1714912763,formattedLastUpdatedAt:"May 5, 2024",frontMatter:{draft:!1},sidebar:"tutorialSidebar",previous:{title:"Large tables of data",permalink:"/frontend/Advanced/Slides/tables"},next:{title:"Indicators",permalink:"/frontend/Advanced/Dynamics/Indicators"}},c={},d=[{value:"Summary",id:"summary",level:2},{value:"Way 1",id:"way-1",level:3},{value:"Way 2",id:"way-2",level:3},{value:"Creating and removing objects",id:"creating-and-removing-objects",level:2},{value:"Simple example",id:"simple-example",level:3},{value:"Animating bubbles",id:"animating-bubbles",level:3},{value:"Pool of objects",id:"pool-of-objects",level:4}];function l(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.M)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,t.jsx)(n.h3,{id:"way-1",children:"Way 1"}),"\n",(0,t.jsxs)(n.p,{children:["Consider to use ",(0,t.jsx)(n.strong,{children:"to get the highest frame-rate"})," and ",(0,t.jsx)(n.strong,{children:"smooth animations"})]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"/frontend/Reference/Graphics/AnimationFrameListener",children:"AnimationFrameListener"})," for ",(0,t.jsx)(n.a,{href:"/frontend/Reference/Graphics/",children:"Graphics"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"/frontend/Reference/Graphics3D/AnimationFrameListener",children:"AnimationFrameListener"})," for ",(0,t.jsx)(n.a,{href:"/frontend/Reference/Graphics3D/",children:"Graphics3D"})]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["with ",(0,t.jsx)(n.a,{href:"/frontend/Reference/Graphics/TransitionType",children:"TransitionType"})," set to ",(0,t.jsx)(n.code,{children:"None"})," if the calculation time does not exceed the ",(0,t.jsx)(n.code,{children:"1/60"})," of the second. Otherwise consider to use ",(0,t.jsx)(n.code,{children:'"Linear"'})," interpolation option and a small amount of ",(0,t.jsx)(n.a,{href:"/frontend/Reference/Graphics/TransitionDuration",children:"TransitionDuration"})," around 10-100 depending on how long it takes to update the data."]}),"\n",(0,t.jsx)(n.h3,{id:"way-2",children:"Way 2"}),"\n",(0,t.jsxs)(n.p,{children:["Consider to use ",(0,t.jsx)(n.a,{href:"/frontend/Reference/Misc/Async#%60SetInterval%60",children:(0,t.jsx)(n.code,{children:"SetInterval"})})," for a slow animations and simple stuff. Set ",(0,t.jsx)(n.a,{href:"/frontend/Reference/Graphics/TransitionDuration",children:"TransitionDuration"})," and ",(0,t.jsx)(n.a,{href:"/frontend/Reference/Graphics/TransitionType",children:"TransitionType"})," to a proper value to interpolate the values."]}),"\n",(0,t.jsxs)(n.p,{children:["Usually if your ",(0,t.jsx)(n.a,{href:"/frontend/Reference/Misc/Async#%60SetInterval%60",children:(0,t.jsx)(n.code,{children:"SetInterval"})})," is let's say ",(0,t.jsx)(n.code,{children:"100 ms"}),", then ",(0,t.jsx)(n.a,{href:"/frontend/Reference/Graphics/TransitionDuration",children:"TransitionDuration"})," should be around ",(0,t.jsx)(n.code,{children:"100 ms"})," as well to get ",(0,t.jsx)(n.em,{children:"the smoothest animation"}),"."]}),"\n",(0,t.jsx)(n.admonition,{type:"info",children:(0,t.jsx)(n.p,{children:"See examples in the each reference page"})}),"\n",(0,t.jsx)(n.h2,{id:"creating-and-removing-objects",children:"Creating and removing objects"}),"\n",(0,t.jsxs)(n.p,{children:["The most examples given on the pages ",(0,t.jsx)(n.a,{href:"/frontend/Dynamics",children:"Dynamics"}),", ",(0,t.jsx)(n.a,{href:"/frontend/Reference/Graphics/AnimationFrameListener",children:"AnimationFrameListener"})," considers only changing the attributes of created graphics primitives on the screen. One can also use pure raster graphics together with ",(0,t.jsx)(n.a,{href:"/frontend/Reference/Graphics/Image",children:"Image"}),", however, this is quite cumbersome to deal with."]}),"\n",(0,t.jsxs)(n.p,{children:["However, you have seen ",(0,t.jsx)(n.a,{href:"/frontend/Reference/Frontend%20IO/MetaMarker",children:"MetaMarker"}),", you might know the solution. The technique of selecting already evaluated entities  on the frontend and evaluating or removing other symbols inside its context comes handy here."]}),"\n",(0,t.jsx)(n.h3,{id:"simple-example",children:"Simple example"}),"\n",(0,t.jsxs)(n.p,{children:["Here we will append colorful ",(0,t.jsx)(n.a,{href:"/frontend/Reference/Graphics/Disk",children:"Disk"})," s to a ",(0,t.jsx)(n.a,{href:"/frontend/Reference/Graphics/",children:"Graphics"})," symbol context following the mouse position. As usual the best way to do it is to use white ",(0,t.jsx)(n.a,{href:"/frontend/Reference/Graphics/Rectangle",children:"Rectangle"})," \ud83d\ude00"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-mathematica",metastring:'title="cell 1"',children:'Graphics[{White, EventHandler[Rectangle[{-1,-1}, {1,1}], {"mousemove"->handler}], MetaMarker["canvas"]}, ImagePadding->None]\n'})}),"\n",(0,t.jsxs)(n.p,{children:["The last thing is to define ",(0,t.jsx)(n.code,{children:"handler"})," function"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-mathematica",children:'With[{win = CurrentWindow[]},\n  handler = Function[xy, \n    FrontSubmit[{\n      Hue[RandomReal[{0,1}], 1,1],\n      Disk[xy, RandomReal[{0.01,0.1}]]\n    }, MetaMarker["canvas"], "Window"->win]\n  ];\n];\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Here we use sort of selector ",(0,t.jsx)(n.a,{href:"/frontend/Reference/Frontend%20IO/MetaMarker",children:"MetaMarker"}),", which makes sure, that the result will be evaluated ",(0,t.jsx)(n.strong,{children:"in the context of all instances"})," marked as ",(0,t.jsx)(n.code,{children:"canvas"}),". The next odd thing is ",(0,t.jsx)(n.a,{href:"/frontend/Reference/Frontend%20IO/CurrentWindow",children:"CurrentWindow"}),". We need this otherwise our anonymous function does not know to which window it should send an expression"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:a(72560).c+"",width:"434",height:"274"})}),"\n",(0,t.jsx)(n.h3,{id:"animating-bubbles",children:"Animating bubbles"}),"\n",(0,t.jsx)(n.p,{children:"We can go further and not only animate bubbles, but also remove them, when there are to many of them."}),"\n",(0,t.jsx)(n.p,{children:"The complexity of many instances comes mostly from the fact, that we don't have a direct access from Wolfram Kernel to the frontend, but only WebSockets protocol, which gives a big overhead. The only solution to maintain good performance is to minimize numbers of transactions."}),"\n",(0,t.jsx)(n.p,{children:"Think about it was a GPU-CPU communication, which also comes with similar restrictions."}),"\n",(0,t.jsx)(n.h4,{id:"pool-of-objects",children:"Pool of objects"}),"\n",(0,t.jsx)(n.p,{children:"This is going to be our buffers"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-mathematica",children:"cPool = Table[{0.,0.}, {i,100}]; (* positions *)\nvPool = cPool; (* velocities *)\nrPool = Table[0., {i,100}]; (* radius or lifetime *)\n\noPool = Table[Null, {i,100}]; (* references to objects *)\n"})}),"\n",(0,t.jsx)(n.p,{children:"The general idea is not to allocate new variables for new object, but rather reuse objects from the pool."}),"\n",(0,t.jsx)(n.p,{children:"Graphical output is going to be the same"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-mathematica",children:'Graphics[{White, EventHandler[Rectangle[{-1,-1}, {1,1}], {"mousemove"->handler}], MetaMarker["canvas"]}, ImagePadding->None]\n'})}),"\n",(0,t.jsx)(n.p,{children:"Our future animation loop is going to look like this"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-mathematica",children:'With[{win = CurrentWindow[]},\n  handler = Function[xy, \n    If[!created[xy, "canvas", win], update[win]];\n  ];\n];\n'})}),"\n",(0,t.jsxs)(n.p,{children:["We ",(0,t.jsx)(n.strong,{children:"don't need to evaluate it now"})]}),"\n",(0,t.jsx)(n.p,{children:"An update functions - just go over our arrays and produce new"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-mathematica",children:"update[win_] := With[{},\n  {cPool, rPool} = Transpose[MapIndexed[Function[{a, index},\n    (* if slot is not empty - recalculate *)\n    If[oPool[[index//First]] =!= Null,\n        \n      If[a[[2]] <= 0.002, \n        (* if radius is too small - remove an object *)\n        remove[index//First, win];\n        a\n      ,\n        (* if ok - animate *)\n        {a[[1]] + 0.05 vPool[[index//First]], 0.9 a[[2]]}\n      ]\n      \n    ,\n      a\n    ]\n    \n  ], {cPool, rPool} // Transpose]];\n];\n"})}),"\n",(0,t.jsx)(n.p,{children:"if a lifetime is close to zero, we need to remove created instance and free some slots in our buffers for new objects"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-mathematica",children:'remove[index_, win_] := (\n  (* destroy instance on the frontend *)\n  Delete[oPool[[index]], "Window"->win]; \n  oPool[[index]] = Null\n);\n'})}),"\n",(0,t.jsx)(n.p,{children:"And finally a function to create new objects"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-mathematica",children:'created[xy_, marker_String, win_] := With[{\n  (* find empty slot *)\n  slot = FirstPosition[oPool, Null]\n},\n  If[!MissingQ[slot],\n    With[{s = slot // First},\n\n      (* initial positions and etc *)\n      cPool[[s]] = xy;\n      rPool[[s]] = 0.05;\n      vPool[[s]] = RandomReal[{-1,1}, 2];\n      oPool[[s]] = True;\n\n      (* update so that object wont appear in an odd way *)\n      update[win];\n\n      (* create an instance of Disk on a graph *)\n      With[{\n        o = {\n          Hue[RandomReal[{0,1}],1,1],\n                                                (* prevent double updates *)\n          Disk[Offload[cPool[[s]]], Offload[rPool[[s]], "Static"->True]]\n        }\n      },\n        oPool[[s]] = FrontSubmit[o, MetaMarker[marker], "Window"->win, "Tracking"->True];\n      ];\n    ];\n\n    True\n  ,\n    False\n  ]\n]\n'})}),"\n",(0,t.jsxs)(n.p,{children:["The big difference to the previous example ",(0,t.jsx)(n.a,{href:"#Simple%20example",children:"Simple example"})," is that we track our created instances using an options ",(0,t.jsx)(n.code,{children:'"Tracking"'}),", so that we can remove them later for our SVG canvas (aka ",(0,t.jsx)(n.a,{href:"/frontend/Reference/Graphics/",children:"Graphics"}),")"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:a(83744).c+"",width:"404",height:"278"})}),"\n",(0,t.jsxs)(n.p,{children:["All positions and radiuses are passed in two solid symbols ",(0,t.jsx)(n.code,{children:"cPool"})," and ",(0,t.jsx)(n.code,{children:"rPool"}),", then we only need to perform two data transactions to our frontend, which saves a lot of resources, when it comes to make objects flying on the screen. Because of the payload matters less, than each act of transactions in terms of the transport load."]})]})}function h(e={}){const{wrapper:n}={...(0,i.M)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},83744:(e,n,a)=>{a.d(n,{c:()=>t});const t=a.p+"assets/images/Bubbles video to gif-e6769380f627f9aeca39fa8709b4461c.gif"},72560:(e,n,a)=>{a.d(n,{c:()=>t});const t=a.p+"assets/images/Canvas Buggles1-79f59d8c708cc52c954b0d46114ba7af.gif"},4552:(e,n,a)=>{a.d(n,{I:()=>s,M:()=>r});var t=a(11504);const i={},o=t.createContext(i);function r(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);